unit TestBufferInterpreter.NVMe.Intel;
{

  Delphi DUnit Test Case
  ----------------------
  This unit contains a skeleton test case class generated by the Test Case Wizard.
  Modify the generated code to correctly setup and call the methods from the unit 
  being tested.

}

interface

uses
  TestFramework, Device.SMART.List, SysUtils, MeasureUnit.DataSize,
  BufferInterpreter, BufferInterpreter.NVMe.Intel;

type
  // Test methods for class TIntelBufferInterpreter

  TestTIntelBufferInterpreter = class(TTestCase)
  strict private
    FIntelBufferInterpreter: TIntelBufferInterpreter;
  private
    procedure CompareWithOriginalIdentify(
      const ReturnValue: TIdentifyDeviceResult);
  public
    procedure SetUp; override;
    procedure TearDown; override;
  published
    procedure TestBufferToIdentifyDeviceResult;
    procedure TestBufferToSMARTValueList;
    procedure TestLargeBufferToIdentifyDeviceResult;
    procedure TestLargeBufferToSMARTValueList;
    procedure TestBufferToCapacityAndLBA;
    procedure TestVendorSpecificSMARTValueList;
  end;

const
  Intel750IdentifyDevice: TSmallBuffer =
    ($86,$80,$86,$80,$43,$56,$43,$51,$35,$33,$30,$34,$30,$30,$41,$50,$34,$30,$30,$41
    ,$47,$4E,$20,$20,$49,$4E,$54,$45,$4C,$20,$53,$53,$44,$50,$45,$44,$4D,$57,$34,$30
    ,$30,$47,$34,$20,$20,$20,$20,$20,$20,$20,$20,$20,$20,$20,$20,$20,$20,$20,$20,$20
    ,$20,$20,$20,$20,$38,$45,$56,$31,$30,$31,$37,$34,$00,$E4,$D2,$5C,$00,$05,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$06,$00,$03,$03
    ,$02,$02,$3F,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00);

  Intel750SMART: TSmallBuffer =
    ($00,$31,$01,$64,$0A,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$98,$04,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$8B,$1C,$02,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$E1,$88,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$75,$8A,$10,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$81,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$F8,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$2A,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00);

  Intel750Capacity: TSmallBuffer =
    ($00,$00,$00,$00,$2E,$93,$90,$AF,$00,$00,$02,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00);

  Intel750AdditionalSMART: TSmallBuffer =
    ($AB,$00,$00,$64,$00,$00,$00,$00,$00,$00,$00,$00
    ,$AC,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$AD,$00,$00,$00,$00,$01,$00,$05,$00,$03,$00,$00
    ,$B8,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$C7,$00,$00,$00,$00,$63,$00,$00,$00,$00,$00,$00
    ,$E2,$00,$00,$00,$00,$FF,$FF,$00,$00,$00,$00,$00
    ,$E3,$00,$00,$00,$00,$FF,$FF,$00,$00,$00,$00,$00
    ,$E4,$00,$00,$00,$00,$FF,$FF,$00,$00,$00,$00,$00
    ,$EA,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$F0,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$F3,$00,$00,$00,$00,$01,$00,$00,$00,$00,$00,$00
    ,$F4,$00,$00,$00,$00,$CA,$5B,$00,$00,$00,$00,$00
    ,$F5,$00,$00,$00,$00,$76,$08,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    ,$00,$00,$00,$00,$00,$00,$00,$00);

implementation

procedure TestTIntelBufferInterpreter.SetUp;
begin
  FIntelBufferInterpreter := TIntelBufferInterpreter.Create;
end;

procedure TestTIntelBufferInterpreter.TearDown;
begin
  FIntelBufferInterpreter.Free;
  FIntelBufferInterpreter := nil;
end;

procedure TestTIntelBufferInterpreter.TestBufferToIdentifyDeviceResult;
var
  ReturnValue: TIdentifyDeviceResult;
  Buffer: TSmallBuffer;
begin
  StartExpectingException(ESmallBufferException);
  ReturnValue := FIntelBufferInterpreter.BufferToIdentifyDeviceResult(Buffer);
  StopExpectingException;
end;

procedure TestTIntelBufferInterpreter.TestBufferToSMARTValueList;
var
  ReturnValue: TSMARTValueList;
  Buffer: TSmallBuffer;
begin
  StartExpectingException(ESmallBufferException);
  ReturnValue := FIntelBufferInterpreter.BufferToSMARTValueList(Buffer);
  StopExpectingException;
end;

procedure TestTIntelBufferInterpreter.TestLargeBufferToIdentifyDeviceResult;
var
  ReturnValue: TIdentifyDeviceResult;
  Buffer: TLargeBuffer;
begin
  FillChar(Buffer, SizeOf(Buffer), #0);
  Move(Intel750IdentifyDevice, Buffer, SizeOf(Intel750IdentifyDevice));
  ReturnValue :=
    FIntelBufferInterpreter.LargeBufferToIdentifyDeviceResult(Buffer);
  CompareWithOriginalIdentify(ReturnValue);
end;

procedure TestTIntelBufferInterpreter.CompareWithOriginalIdentify(
  const ReturnValue: TIdentifyDeviceResult);
begin
  CheckEquals('INTEL SSDPEDMW400G4', ReturnValue.Model);
  CheckEquals('8EV10174', ReturnValue.Firmware);
  CheckEquals('CVCQ530400AP400AGN', ReturnValue.Serial);
  CheckTrue(TSATASpeed.NotSATA = ReturnValue.SATASpeed,
    'TSATASpeed.NotSATA = ReturnValue.SATASpeed');
  CheckEquals(512, ReturnValue.LBASize);
end;

(((0, 0, 0, 0, 0), (1, 0, 0, 0, 305), (2, 0, 0, 10, 100), (3, 0, 0, 0, 0), (4, 0, 0, 0, 1473), (5, 0, 0, 0, 141976), (6, 0, 0, 0, 38232), (7, 0, 0, 0, 1113255), (8, 0, 0, 0, 0), (9, 0, 0, 0, 131), (10, 0, 0, 0, 264), (11, 0, 0, 0, 42), (12, 0, 0, 0, 0), (13, 0, 0, 0, 0), (0, 0, 0, 0, 0), (0, 0, 0, 0, 0)), 14, Pointer($3493980) as {System.Generics.Defaults}IComparer<Device.SMART.List.TSMARTValueEntry>, (nil,nil), $34936A0)
procedure TestTIntelBufferInterpreter.TestLargeBufferToSMARTValueList;
var
  ReturnValue: TSMARTValueList;
  Buffer: TLargeBuffer;
begin
  FillChar(Buffer, SizeOf(Buffer), #0);
  Move(Intel750SMART, Buffer, SizeOf(Intel750SMART));
  ReturnValue := FIntelBufferInterpreter.LargeBufferToSMARTValueList(Buffer);
  // TODO: Validate method results
end;

procedure TestTIntelBufferInterpreter.TestBufferToCapacityAndLBA;
var
  ReturnValue: TIdentifyDeviceResult;
  Buffer: TSmallBuffer;
begin
  Buffer := Intel750Capacity;
  ReturnValue := FIntelBufferInterpreter.BufferToCapacityAndLBA(Buffer);
  CheckEquals(ReturnValue.UserSizeInKB, 400088457);
end;

(((171, 100, 0, 0, 0), (172, 0, 0, 0, 0), (173, 0, 0, 0, 12885229569), (184, 0, 0, 0, 0), (199, 0, 0, 0, 99), (226, 0, 0, 0, 65535), (227, 0, 0, 0, 65535), (228, 0, 0, 0, 65535), (234, 0, 0, 0, 0), (240, 0, 0, 0, 0), (243, 0, 0, 0, 1), (244, 0, 0, 0, 23498), (245, 0, 0, 0, 2166), (0, 0, 0, 0, 0), (0, 0, 0, 0, 0), (0, 0, 0, 0, 0)), 13, Pointer($2E71560) as {System.Generics.Defaults}IComparer<Device.SMART.List.TSMARTValueEntry>, (nil,nil), $2E71550)
procedure TestTIntelBufferInterpreter.TestVendorSpecificSMARTValueList;
var
  ReturnValue: TSMARTValueList;
  Buffer: TLargeBuffer;
begin
  FillChar(Buffer, SizeOf(Buffer), #0);
  Move(Intel750AdditionalSMART, Buffer, SizeOf(Intel750AdditionalSMART));
  ReturnValue := FIntelBufferInterpreter.VendorSpecificSMARTValueList(Buffer);
  // TODO: Validate method results
end;

initialization
  // Register any test cases with the test runner
  RegisterTest(TestTIntelBufferInterpreter.Suite);
end.

